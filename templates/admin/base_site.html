{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
    {{ block.super}}
    <link rel="stylesheet" type="text/css" href="{% static 'css/custom_admin.css' %}">
{% endblock %}

{% block nav-global %}
    {{ block.super }}
    <div>
        <button id="cms-link" onclick="window.open('{{ cms_link }}', '_blank')"> 
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAADjElEQVR4nO2YX0hTURzHb1S+RNBDPfbUS+/11kMWarDhmwM3N+/dtKW4TUgCt93bwmm6c4cZqCAkYQn+CY3MPyvLl0jIhBS0pHRB5J+c9CSWM/eLc93uurt307m1P3B/8H3YGefc7+ec3+/c30YQcsghhxwZGSqVKidPXe7KU5et5GvKIU1azteUNWEvcQPgiWk0DkKVNcUNkOadhwitHuIEwgtorDpwegqh3lMI6lotP043FINvMRd8X3LB5iwWPHR2fgH8fv+hNTP/SbBeQgDYOPtGwck5VsiPY+Pgu8Rp/fNlwQMTMe8PSgbIDwqnDYbA5tW1On4cpw2GwOZtTrXggTgFEjH/YS6JKZQJImQATZYBjHt3IJNEyADeLAZomdpOWIdZb1wG8MoAIAN4ZYAdGaDlAADm+z1AMaxAte292QNQXt8qAqi8254lAO9+AXXbLQLAYy+XtjMLoHPiI9R0esA1scaNN09ugrVnUmw+qNbh9/BicZsD0FsbzlAMS1N29mpcAMnS6MImVDS08btb3TYAxsaOqOZDutnSBSTDtlMM2sKfSQZ909awJ1IO4Op7LWmQpBEUWeygNJigQHuDk9JghiKLDSgaRQOrTynAwIwPDI5mkRGdrREUenPUHzIYRGdtFEMz6HepHZ1LWQ3UdY1I7rwihvmQFHpTtJN4mDKAvqnvUOUS5rvKYgvvNFkJ/cMeWFv3cep/PsaNhb5XVduF5mn2q8HmupgyALzOyMImMA+e8iaUhvDuY/ORf630DY2FAfWmwD/mB0nHvVNpuUa733p5gGtaI28Q73okwA/fBv99Qcn13dC8UsZ1Jab5/wnwOA6AtXVfuBZKjDwAaWdz0wIgTiETbxCnSyRAz7MRyRQiGfTEcMt1MjbAkn85mdeoVBEXRRQxhggVce/QKCjIinARWyKLGH0iHe7zMQB2mpIJUPdIfI1SNBIUcoxrNEAyEtcozbqiAvTPQQ4HkaSTGJzdAMMdiReZtTEmBDZfahO/yCiG/Wl0uE8TqQz8+pdsC2jE3fNKvTmAbxsshcEUwGkjufNcIaMqItWBGzDciO2ZQFvBBm16v2aOotErimG7SAb5g6kzq1L1HyXSEbgVxi0xbo0JgiCMxo7jpB2ZpZs8dpek2WKCgCN7c91n8SmSjPsCkUnhcDiOUQz6I4ZAK0S2BEWzqxIA0+n2deAI5nlk7nfvN/EvtgVtn5Y5vXUAAAAASUVORK5CYII=" alt="cms">
            CMS
        </button>
    </div>
    <div id="notif-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span id="notif-count"></span>
        <div id="notif-dropdown">
            <div id="notif-header">
                <h3>Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</h3>
                <button id="mark-all-read">Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ù…Ù‡</button>
            </div>
            <ul id="notif-list">
                <li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>
            </ul>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(protocol + "://" + window.location.host + "/ws/notifications/");

        const icon = document.getElementById("notif-icon");
        const dropdown = document.getElementById("notif-dropdown");
        const notifList = document.getElementById("notif-list");
        const notifCount = document.getElementById("notif-count");
        const markAllRead = document.getElementById("mark-all-read");

        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let unreadCount = notifications.length;

        // Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ø§ Ú©Ù„Ø§Ø³ (Ø¨Ø¯ÙˆÙ† Ø¯Ø³Øªâ€ŒÚ©Ø§Ø±ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… style.display)
        icon.addEventListener("click", function (e) {
            e.stopPropagation();
            dropdown.classList.toggle("open");
            renderNotifications();
        });
        // Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ†
        document.addEventListener("click", function (e) {
            if (!icon.contains(e.target)) dropdown.classList.remove("open");
        });
        // Ø¨Ø³ØªÙ† Ø¨Ø§ ESC
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") dropdown.classList.remove("open");
        });

        // Ø¯Ø±ÛŒØ§ÙØª Ù†ÙˆØªÛŒÙ Ø§Ø² WS
        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            addNotification(data.message, data.ticket_url, data.notif_type || "default");
        };

        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function addNotification(message, url, notifType) {
            const notification = {
                id: generateId(),
                message, ticket_url: url,
                notif_type: notifType || "default",
                time: new Date().toISOString()
            };
            notifications.unshift(notification);
            unreadCount = notifications.length;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        function renderNotifications() {
            notifList.innerHTML = '';

            if (notifications.length === 0) {
                notifList.innerHTML = '<li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>';
            } else {
                notifications.forEach((notif) => {
                    const li = document.createElement("li");
                    li.classList.add("unread");

                    let iconEmoji = "ğŸ””";
                    if (notif.notif_type === "employee_ticket") iconEmoji = "ğŸ‘¨â€ğŸ’¼";
                    else if (notif.notif_type === "reservation") iconEmoji = "ğŸ“…";
                    else if (notif.notif_type === "suggestion") iconEmoji = "ğŸ’¡";

                    const notifTime = new Date(notif.time);
                    const mins = Math.floor((new Date() - notifTime) / (1000 * 60));
                    const timeStr = mins < 1 ? "Ù‡Ù…ÛŒÙ† Ø­Ø§Ù„Ø§" : mins + " Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´";

                    li.innerHTML = `
                        <span class="notif-icon">${iconEmoji}</span>
                        <a href="${notif.ticket_url}" data-id="${notif.id}">
                            ${notif.message}
                        </a>
                        <span class="notif-time">${timeStr}</span>
                    `;

                    li.querySelector("a").addEventListener("click", function (e) {
                        e.preventDefault();
                        const idToRemove = this.getAttribute("data-id");
                        notifications = notifications.filter(n => n.id !== idToRemove);
                        localStorage.setItem('notifications', JSON.stringify(notifications));

                        li.style.animation = "fadeOut 0.3s ease";
                        setTimeout(() => {
                            li.remove();
                            unreadCount = notifications.length;
                            notifCount.innerText = unreadCount;
                            notifCount.style.display = unreadCount > 0 ? "inline-block" : "none";
                            if (notifications.length === 0) {
                                notifList.innerHTML = '<li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>';
                            }
                            window.location.href = this.href;
                        }, 300);
                    });

                    notifList.appendChild(li);
                });
            }

            notifCount.innerText = unreadCount;
            notifCount.style.display = unreadCount > 0 ? "inline-block" : "none";
        }

        markAllRead.addEventListener("click", function () {
            notifications = [];
            unreadCount = 0;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        });

        renderNotifications();
    });
    </script>

{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {% for js_file in custom_js %}
        <script src="{% static js_file %}"></script>
    {% endfor %}
{% endblock %}
