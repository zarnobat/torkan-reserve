{% load static %}

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÛŒØ³Øª ÙˆØ¸Ø§ÛŒÙ Ù…Ù†</title>

  <!-- React -->
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- Jalali Datepicker -->
  <link href="{% static 'admin/css/django_jalali.min.css' %}" rel="stylesheet">
  <script src="{% static 'admin/js/django_jalali.min.js' %}" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>

  <script src="https://cdn.tailwindcss.com/3.4.10"></script>
  <script>
    tailwind.config = { darkMode: 'class', corePlugins: { preflight: true } }
  </script>

  <style>
    [dir="rtl"] .border-l-custom { border-left-width: 6px; }
  </style>
  <script>
    function jalaliToGregorian(jy, jm, jd) {
      jy = parseInt(jy) - 979;
      jm = parseInt(jm) - 1;
      jd = parseInt(jd) - 1;

      var j_day_no = 365 * jy + Math.floor(jy / 33) * 8 + Math.floor(((jy % 33) + 3) / 4);
      for (var i = 0; i < jm; ++i)
        j_day_no += [31,31,31,31,31,31,30,30,30,30,30,29][i];
      j_day_no += jd;

      var g_day_no = j_day_no + 79;

      var gy = 1600 + 400 * Math.floor(g_day_no / 146097);
      g_day_no %= 146097;

      var leap = true;
      if (g_day_no >= 36525) {
        g_day_no--;
        gy += 100 * Math.floor(g_day_no / 36524);
        g_day_no %= 36524;

        if (g_day_no >= 365)
          g_day_no++;
        else
          leap = false;
      }

      gy += 4 * Math.floor(g_day_no / 1461);
      g_day_no %= 1461;

      if (g_day_no >= 366) {
        leap = false;
        g_day_no--;
        gy += Math.floor(g_day_no / 365);
        g_day_no %= 365;
      }

      var gm, gd;
      var g_month_days = [31, (leap ? 29 : 28),31,30,31,30,31,31,30,31,30,31];

      for (gm = 0; gm < 12 && g_day_no >= g_month_days[gm]; gm++)
        g_day_no -= g_month_days[gm];

      gd = g_day_no + 1;
      return `${gy}-${String(gm+1).padStart(2,'0')}-${String(gd).padStart(2,'0')}`;
    }

    function convertInputs() {
      document.querySelectorAll("input[data-jdate]").forEach(input => {
        let val = input.value;
        if (!val) return;

        const parts = val.split("/");
        if (parts.length !== 3) return;

        const [jy, jm, jd] = parts;
        const greg = jalaliToGregorian(jy, jm, jd);

        console.log("Jalali:", val, "â†’ Gregorian:", greg);
        input.dataset.original = val;
        input.value = greg;
      });
    }

    document.addEventListener("change", convertInputs);
  </script>
  <script>
    const CURRENT_USER_ID = {{ request.user.id }};
  </script>


</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
  <div id="root"></div>
  {% csrf_token %}

{% verbatim %}
<script type="text/babel">
  const { useState, useEffect, useRef } = React;

  const TASKS_URL = "/tasks/tasks/";
  const CATEGORIES_URL = "/tasks/categories/";
  const USERS_URL = "/tasks/tasks/users/";

  const safeColor = (color) => color && /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(color) ? color : "#9CA3AF";

  const priorityMap = { low: { text: "Ú©Ù…", color: "bg-green-500" }, medium: { text: "Ù…ØªÙˆØ³Ø·", color: "bg-yellow-500" }, high: { text: "Ø²ÛŒØ§Ø¯", color: "bg-red-500" } };
  const statusMap = { todo: { text: "Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡", color: "bg-gray-500" }, in_progress: { text: "Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…", color: "bg-blue-500" }, done: { text: "Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡", color: "bg-green-500" }, cancelled: { text: "Ù„ØºÙˆ Ø´Ø¯Ù‡", color: "bg-gray-600" } };
  const statusOrder = ["todo", "in_progress", "done", "cancelled"];

  const pad = (num) => (typeof num === "number" && !Number.isNaN(num) ? num.toString().padStart(2, "0") : "");
  const normalizeDigits = (str = "") => str
    .replace(/[\u200c\u200f\u202a-\u202e]/g, "")
    .replace(/[Û°-Û¹]/g, d => String.fromCharCode(d.charCodeAt(0) - 1728))
    .replace(/[Ù¬Ù«]/g, ",");

  const jalaliPattern = /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/;

  const convertGregToJalali = (gregDate) => {
    if (!gregDate) return "";
    const [gy, gm, gd] = gregDate.split("/").map(Number);
    if ([gy, gm, gd].some(n => Number.isNaN(n))) return gregDate;

    if (window?.jalaali?.toJalaali) {
      const { jy, jm, jd } = window.jalaali.toJalaali(gy, gm, gd);
      return `${jy}/${pad(jm)}/${pad(jd)}`;
    }

    return gregDate;
  };

  const convertJalaliToGreg = (jalaliDate) => {
    if (!jalaliDate) return "";
    const s = normalizeDigits(String(jalaliDate)).replace(/[-.]/g, "/").trim();
    const m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
    if (!m) {
      console.warn("convertJalaliToGreg: not a jalali-looking string:", jalaliDate);
      return "";
    }
    const jy = parseInt(m[1], 10);
    const jm = parseInt(m[2], 10);
    const jd = parseInt(m[3], 10);

    if (Number.isNaN(jy) || Number.isNaN(jm) || Number.isNaN(jd)) {
      console.warn("convertJalaliToGreg: parse failed:", jalaliDate);
      return "";
    }

    if (window?.jalaali?.toGregorian && typeof window.jalaali.toGregorian === "function") {
      const { gy, gm, gd } = window.jalaali.toGregorian(jy, jm, jd);
      const out = `${gy}-${pad(gm)}-${pad(gd)}`;
      console.debug("[convertJalaliToGreg] in:", jalaliDate, "->", out, "(via jalaali-js)");
      return out;
    }

    try {
      const out = `${gy}-${pad(gm)}-${pad(gd)}`;
      console.debug("[convertJalaliToGreg] in:", jalaliDate, "->", out, "(via manual)");
      return out;
    } catch (err) {
      console.error("convertJalaliToGreg failed:", err, jalaliDate);
      return "";
    }
  };


  const ensureGregorianDate = (value) => {
    if (!value) return null;
    const trimmed = value.trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) return trimmed;
    const converted = convertJalaliToGreg(trimmed);
    return converted || null;
  };

  function JalaliDateInput({ label, value, onChange, name }) {
  const inputRef = useRef(null);
  const lastValueRef = useRef("");
  const [displayValue, setDisplayValue] = useState(convertGregToJalali(value));

  // helper patterns
  const gregPattern = /^\d{4}-\d{1,2}-\d{1,2}$/;
  const jalaliPatternLocal = /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/;

  const applyValue = React.useCallback((rawValue) => {
    if (rawValue == null) return;
    // cleanup common rubbish and convert persian digits to latin
    const cleanedDigits = normalizeDigits(String(rawValue)).trim();
    // if it looks like ISO Gregorian (2025-11-27) -> accept as Gregorian
    if (gregPattern.test(cleanedDigits)) {
      // ensure zero-padded
      const [gy, gm, gd] = cleanedDigits.split("-").map(n => pad(Number(n)));
      const canonicalGreg = `${gy}-${gm}-${gd}`;
      // set display as corresponding Jalali
      const jal = convertGregToJalali(canonicalGreg);
      lastValueRef.current = jal;
      setDisplayValue(jal);
      onChange(canonicalGreg); // send greg to parent (API-ready)
      return;
    }

    // normalize separators for jalali detection
    const s = cleanedDigits.replace(/\./g, "/").replace(/\s+/g, "/").replace(/[-]/g, "/");
    // If user typed day-first like "01/09/1404" reorder to YYYY/MM/DD for parsing
    const m = s.match(jalaliPatternLocal);
    if (m) {
      // standardize jalali display as YYYY/MM/DD (pad)
      const jy = String(m[1]);
      const jm = pad(Number(m[2]));
      const jd = pad(Number(m[3]));
      const canonicalJal = `${jy}/${jm}/${jd}`;
      lastValueRef.current = canonicalJal;
      setDisplayValue(canonicalJal);
      // convert to gregorian and send to parent
      const greg = convertJalaliToGreg(canonicalJal);
      if (greg) onChange(greg);
      else onChange("");
      return;
    }

    // empty or unrecognized -> clear
    if (cleanedDigits === "") {
      lastValueRef.current = "";
      setDisplayValue("");
      onChange("");
    } else {
      // keep raw as typed but don't send to parent until valid
      lastValueRef.current = cleanedDigits;
      setDisplayValue(cleanedDigits);
    }
  }, [onChange]);

  // Sync when parent value (greg) changes
  useEffect(() => {
    const nextVal = convertGregToJalali(value);
    lastValueRef.current = nextVal;
    setDisplayValue(nextVal);
  }, [value]);

  // attach listeners once
  useEffect(() => {
    const el = inputRef.current;
    if (!el) return;

    const onInput = (e) => {
      const shown = normalizeDigits(el.value || "");
      setDisplayValue(shown);
    };

    const onGregEvent = (ev) => {
      const greg = ev.detail?.greg;
      if (greg) {
        // set state in react (this calls parent's onChange via prop)
        setDisplayValue(convertGregToJalali(greg));
        onChange(greg);
      }
    };

    el.addEventListener('input', onInput);
    el.addEventListener('jalali:greg', onGregEvent);

    return () => {
      el.removeEventListener('input', onInput);
      el.removeEventListener('change', onInput);
      el.removeEventListener('jalali:greg', onGregEvent);
    };
  }, [onChange]);


  const handleChange = (e) => applyValue(e.target.value);

  return (
    <div>
      <label className="block font-semibold mb-2">{label}</label>
      <input
        type="text"
        data-jdp
        data-jdp-only-date="true"
        data-field-name={name}
        id={`jalali-${name}`}
        ref={inputRef}
        value={displayValue}
        onChange={handleChange}
        className="jalali-date-input w-full border rounded-xl px-4 py-3 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500"
        placeholder="Ù…Ø«Ø§Ù„: 1403/01/15"
        dir="rtl"
        inputMode="numeric"
        autoComplete="off"
      />
    </div>
  );
}


  function App() {
    const [tasks, setTasks] = useState([]);
    const [categories, setCategories] = useState([]);
    const [users, setUsers] = useState([]);
    const [darkMode, setDarkMode] = useState(false);
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [searchTerm, setSearchTerm] = useState("");
    const [filterMode, setFilterMode] = useState("all");
    const [priorityFilter, setPriorityFilter] = useState("all"); // all | high | medium | low
    const [sidebarOpen, setSidebarOpen] = useState(false);

    const [showTaskForm, setShowTaskForm] = useState(false);
    const [currentTask, setCurrentTask] = useState(null);
    const [taskForm, setTaskForm] = useState({ title: "", description: "", start_date: "", end_date: "", priority: "medium", status: "todo", category: "", assignee: CURRENT_USER_ID.toString() });

    const [showCatForm, setShowCatForm] = useState(false);
    const [currentCat, setCurrentCat] = useState(null);
    const [catForm, setCatForm] = useState({ name: "", color: "#3B82F6" });

    const today = new Date().toISOString().split("T")[0];

    useEffect(() => {
      fetchTasks();
      fetchCategories();
      fetchUsers();
    }, []);

    useEffect(() => {
      document.documentElement.classList.toggle('dark', darkMode);
    }, [darkMode]);

    useEffect(() => {
      if (!showTaskForm) return;
      const init = () => {
        if (!window?.jalaliDatepicker) return;
        try {
          window.jalaliDatepicker.startWatch({
            selector: ".jalali-date-input",
            autoSubmit: true,
            time: false,
            showTodayBtn: true,
            changeMonth: true,
            changeYear: true,
            observer: true,
            select: function(value, inputEl) {
              try {
                console.debug("[jalali select] raw value from datepicker:", value);
                if (inputEl && inputEl.value !== value) {
                  inputEl.value = value;
                  inputEl.dispatchEvent(new Event('input', { bubbles: true }));
                  inputEl.dispatchEvent(new Event('change', { bubbles: true }));
                }
              
                const fieldName = inputEl?.getAttribute('data-field-name') || inputEl?.id || null;
              
                // convert
                const greg = convertJalaliToGreg(value);
                console.debug(`[jalali select] field=${fieldName} jalali=${value} -> greg=${greg}`);
              
                if (greg) {
                  inputEl?.dispatchEvent(new CustomEvent('jalali:greg', { detail: { greg } , bubbles:true }));
                } else {
                  console.warn("[jalali select] conversion returned empty for", value);
                }
              } catch (err) {
                console.error('jalali select handler error', err);
              }
          }

          });
        } catch (e) {
          console.error('jalaliDatepicker startWatch failed', e);
        }
      };
      const t = setTimeout(init, 0);
      return () => {
        clearTimeout(t);
        if (window?.jalaliDatepicker?.updateOptions) {
          try { window.jalaliDatepicker.updateOptions({ selector: null }); } catch(e) {}
        }
      };
    }, [showTaskForm]);


    const getCsrfToken = () => document.querySelector('[name=csrfmiddlewaretoken]').value;

    const commonFetch = (url, options = {}) => fetch(url, {
      credentials: 'include',
      ...options,
      headers: { "Content-Type": "application/json", "X-CSRFToken": getCsrfToken(), ...options.headers }
    });

    const fetchTasks = async () => {
      try {
        const res = await commonFetch(TASKS_URL);
        if (!res.ok) throw new Error();
        const data = await res.json();
        setTasks(Array.isArray(data) ? data : data.results || []);
      } catch (e) { console.error(e); }
    };

    const fetchCategories = async () => {
      try {
        const res = await commonFetch(CATEGORIES_URL);
        if (!res.ok) throw new Error();
        const data = await res.json();
        setCategories(Array.isArray(data) ? data : data.results || []);
      } catch (e) { console.error(e); }
    };

    const fetchUsers = async () => {
      try {
        const res = await commonFetch(USERS_URL);
        if (res.ok) setUsers(await res.json());
      } catch (e) { console.error(e); }
    };

    const getUserName = (id) => {
      if (!id) return "Ù†Ø§Ù…Ø´Ø®Øµ";
      if (id === CURRENT_USER_ID) return "Ù…Ù†";
      const user = users.find(u => u.id === id);
      return user ? (user.name || user.email || `Ú©Ø§Ø±Ø¨Ø± ${id}`) : `Ú©Ø§Ø±Ø¨Ø± ${id}`;
    };

    const handleStatusChange = async (taskId, newStatus) => {
      try {
        const res = await commonFetch(`${TASKS_URL}${taskId}/set_status/`, { method: "POST", body: JSON.stringify({ status: newStatus }) });
        if (res.ok) setTasks(prev => prev.map(t => t.id === taskId ? {...t, status: newStatus} : t));
        else { const err = await res.text(); alert("Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª:\n" + err); fetchTasks(); }
      } catch (e) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·"); fetchTasks(); }
    };

    const onDragStart = (e, taskId) => e.dataTransfer.setData("taskId", taskId);
    const onDragOver = (e) => e.preventDefault();
    const onDrop = (e, newStatus) => {
      e.preventDefault();
      const taskId = parseInt(e.dataTransfer.getData("taskId"));
      if (isNaN(taskId)) return;
      const currentTask = tasks.find(t => t.id === taskId);
      if (currentTask && currentTask.status !== newStatus) handleStatusChange(taskId, newStatus);
    };

    const saveTask = async () => {
      if (!taskForm.title.trim()) return alert("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
      if (!taskForm.assignee) return alert("Ø§Ù†Ø¬Ø§Ù…â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");

      const domStart = document.getElementById("jalali-start_date")?.value || "";
      const domEnd = document.getElementById("jalali-end_date")?.value || "";

      const normalizedStart = ensureGregorianDate(taskForm.start_date || domStart);
      const normalizedEnd = ensureGregorianDate(taskForm.end_date || domEnd);

      if (taskForm.start_date && !normalizedStart) {
        return alert("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
      }
      if (taskForm.end_date && !normalizedEnd) {
        return alert("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
      }

      const url = currentTask ? `${TASKS_URL}${currentTask.id}/` : TASKS_URL;
      const method = currentTask ? "PUT" : "POST";

      const payload = {
        title: taskForm.title.trim(),
        description: taskForm.description || null,
        start_date: normalizedStart,
        end_date: normalizedEnd,
        priority: taskForm.priority,
        status: taskForm.status,
        category: taskForm.category ? parseInt(taskForm.category) : null,
        assignee: parseInt(taskForm.assignee)
      };

      try {
        const res = await commonFetch(url, { method, body: JSON.stringify(payload) });
        if (res.ok) {
          fetchTasks();
          setShowTaskForm(false);
          setCurrentTask(null);
          setTaskForm({title:"", description:"", start_date:"", end_date:"", priority:"medium", status:"todo", category:"", assignee: CURRENT_USER_ID.toString()});
        } else {
          const err = await res.text();
          alert("Ø®Ø·Ø§:\n" + err);
        }
      } catch (e) { alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"); }
    };

    const saveCategory = async () => {
      if (!catForm.name.trim()) return alert("Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");

      const url = currentCat ? `${CATEGORIES_URL}${currentCat.id}/` : CATEGORIES_URL;
      const method = currentCat ? "PUT" : "POST";

      try {
        const res = await commonFetch(url, {
          method,
          body: JSON.stringify({
            name: catForm.name.trim(),
            color: catForm.color
          })
        });

        if (res.ok) {
          fetchCategories();
          setShowCatForm(false);
          setCurrentCat(null);
          setCatForm({ name: "", color: "#3B82F6" });
        } else {
          const err = await res.text();
          alert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªÙ‡:\n" + err);
        }
      } catch (e) { alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"); }
    };

    const deleteTask = async (id) => {
      if (!confirm("Ø­Ø°Ù ÙˆØ¸ÛŒÙÙ‡ØŸ")) return;
      await commonFetch(`${TASKS_URL}${id}/`, { method: "DELETE" });
      fetchTasks();
    };

    const deleteCategory = async (id) => {
      if (!confirm("Ø¯Ø³ØªÙ‡ Ùˆ ØªÙ…Ø§Ù… ÙˆØ¸Ø§ÛŒÙ Ø¢Ù† Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ")) return;
      await commonFetch(`${CATEGORIES_URL}${id}/`, { method: "DELETE" });
      fetchCategories();
      fetchTasks();
    };

    const openEditTask = (task) => {
      setCurrentTask(task);
      setTaskForm({
        title: task.title,
        description: task.description || "",
        start_date: task.start_date || "",
        end_date: task.end_date || "",
        priority: task.priority,
        status: task.status,
        category: task.category ? task.category.id : "",
        assignee: task.assignee.toString()
      });
      setShowTaskForm(true);
    };

    const filteredTasks = tasks.filter(task => {
      const matchesCategory = selectedCategory === null || (task.category && task.category.id === selectedCategory);
      const matchesSearch = task.title.toLowerCase().includes(searchTerm.toLowerCase()) || (task.description && task.description.toLowerCase().includes(searchTerm.toLowerCase()));
      const matchesPriority = priorityFilter === "all" || task.priority === priorityFilter;

      if (filterMode === "my") return matchesCategory && matchesSearch && matchesPriority && task.assignee === CURRENT_USER_ID;
      if (filterMode === "today") return matchesCategory && matchesSearch && matchesPriority && task.is_today;
      if (filterMode === "from_admin") return matchesCategory && matchesSearch && matchesPriority && task.creator !== CURRENT_USER_ID;
      if (filterMode === "done") return matchesCategory && matchesSearch && matchesPriority && task.status === "done";
      if (filterMode === "my_created") return matchesCategory && matchesSearch && matchesPriority && task.creator === CURRENT_USER_ID;

      return matchesCategory && matchesSearch && matchesPriority;
    });

    return (
      <div className="flex min-h-screen bg-gray-100 dark:bg-gray-900">
        {/* Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */}
        <div className={`fixed inset-0 z-50 w-72 bg-white dark:bg-gray-800 shadow-xl transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static transition-transform duration-300 overflow-y-auto`}>
          <div className="p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-xl font-bold">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h2>
              <button onClick={() => { setCurrentCat(null); setCatForm({name: "", color: "#3B82F6"}); setShowCatForm(true); }} className="text-3xl text-blue-600 hover:scale-110 transition">+</button>
              <button onClick={() => setSidebarOpen(false)} className="md:hidden text-3xl">Ã—</button>
            </div>
            <button onClick={() => setSelectedCategory(null)} className={`w-full text-right py-3 px-4 rounded-lg mb-4 transition ${selectedCategory === null ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700'}`}>
              Ù‡Ù…Ù‡ ÙˆØ¸Ø§ÛŒÙ
            </button>
            {categories.map(cat => (
              <div key={cat.id} className="flex items-center justify-between py-3 px-4 rounded-lg mb-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition" onClick={() => { setSelectedCategory(cat.id); setSidebarOpen(false); }}>
                <div className="flex items-center gap-3">
                  <div className="w-7 h-7 rounded-full" style={{ backgroundColor: safeColor(cat.color) }}></div>
                  <span className="font-medium">{cat.name}</span>
                </div>
                <div className="flex gap-2 text-sm">
                  <button onClick={(e) => { e.stopPropagation(); setCurrentCat(cat); setCatForm({name: cat.name, color: cat.color || "#3B82F6"}); setShowCatForm(true); }}>ÙˆÛŒØ±Ø§ÛŒØ´</button>
                  <button onClick={(e) => { e.stopPropagation(); deleteCategory(cat.id); }} className="text-red-600">Ø­Ø°Ù</button>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ */}
        <div className="flex-1 flex flex-col">
          {/* Ù‡Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */}
          <div className="md:hidden bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center">
            <button onClick={() => setSidebarOpen(true)} className="text-3xl">â˜°</button>
            <h1 className="text-2xl font-bold">Ù„ÛŒØ³Øª ÙˆØ¸Ø§ÛŒÙ</h1>
            <button onClick={() => setDarkMode(d => !d)} className="text-2xl">{darkMode ? "â˜€ï¸" : "ğŸŒ™"}</button>
          </div>

          <div className="flex-1 p-4 md:p-8 overflow-y-auto">
            <div className="mb-8">
              <h1 className="hidden md:block text-4xl font-bold mb-6">Ù„ÛŒØ³Øª ÙˆØ¸Ø§ÛŒÙ Ù…Ù†</h1>
              <div className="flex flex-col gap-4">
                <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                       className="px-5 py-3 rounded-xl border bg-white dark:bg-gray-800 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" />

                <div className="flex flex-wrap gap-2">
                  <select value={filterMode} onChange={e => setFilterMode(e.target.value)} className="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700">
                    <option value="all">Ù‡Ù…Ù‡</option>
                    <option value="my">ÙˆØ¸Ø§ÛŒÙ Ù…Ù†</option>
                    <option value="today">ÙˆØ¸Ø§ÛŒÙ Ø§Ù…Ø±ÙˆØ²</option>
                    <option value="from_admin">ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†</option>
                    <option value="done">ÙˆØ¸Ø§ÛŒÙ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
                    <option value="my_created">ÙˆØ¸Ø§ÛŒÙ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ù…Ù†</option>
                  </select>

                  <select value={priorityFilter} onChange={e => setPriorityFilter(e.target.value)} className="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700">
                    <option value="all">Ù‡Ù…Ù‡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§</option>
                    <option value="high">Ø²ÛŒØ§Ø¯</option>
                    <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                    <option value="low">Ú©Ù…</option>
                  </select>

                  <button onClick={() => setDarkMode(d => !d)} className="hidden md:block text-3xl hover:scale-110 transition">
                    {darkMode ? "â˜€ï¸" : "ğŸŒ™"}
                  </button>

                  <button onClick={() => { setCurrentTask(null); setTaskForm({title:"", description:"", start_date:"", end_date:"", priority:"medium", status:"todo", category:"", assignee: CURRENT_USER_ID.toString()}); setShowTaskForm(true); }} className="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition shadow-lg">
                    + ÙˆØ¸ÛŒÙÙ‡ Ø¬Ø¯ÛŒØ¯
                  </button>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {statusOrder.map(st => (
                <div key={st} onDragOver={onDragOver} onDrop={(e) => onDrop(e, st)} className="bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-4 md:p-6 shadow-inner">
                  <h3 className="font-bold text-lg mb-4 flex items-center justify-between">
                    <span>{statusMap[st].text}</span>
                    <span className={`text-white px-3 py-1 rounded-full text-xs font-bold ${statusMap[st].color}`}>
                      {filteredTasks.filter(t => t.status === st).length}
                    </span>
                  </h3>
                  <div className="space-y-4">
                    {filteredTasks.filter(t => t.status === st).map(task => {
                      const isOverdue = task.end_date && task.end_date < today && task.status !== "done" && task.status !== "cancelled";
                      return (
                        <div key={task.id}
                             draggable
                             onDragStart={(e) => onDragStart(e, task.id)}
                             className="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-5 border-l-custom hover:shadow-2xl transition cursor-move select-none"
                             style={{ borderLeftColor: safeColor(task.category?.color) }}>
                          <h4 className="font-bold text-lg mb-2">{task.title}</h4>
                          {task.description && <p className="text-gray-600 dark:text-gray-300 text-sm mb-4">{task.description}</p>}
                          <div className="flex flex-wrap gap-2 mb-4">
                            <span className={`text-white px-3 py-1 rounded-full text-xs font-medium ${priorityMap[task.priority].color}`}>
                              {priorityMap[task.priority].text}
                            </span>
                            {task.is_today && <span className="bg-purple-600 text-white px-3 py-1 rounded-full text-xs">Ø§Ù…Ø±ÙˆØ²</span>}
                            {isOverdue && <span className="bg-red-600 text-white px-3 py-1 rounded-full text-xs">Ø¹Ù‚Ø¨ Ø§ÙØªØ§Ø¯Ù‡</span>}
                          </div>
                          <div className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                            Ø§ÛŒØ¬Ø§Ø¯Ú©Ù†Ù†Ø¯Ù‡: {getUserName(task.creator)} | Ø§Ù†Ø¬Ø§Ù…â€ŒØ¯Ù‡Ù†Ø¯Ù‡: {getUserName(task.assignee)}
                          </div>
                          <div className="flex gap-4 text-sm">
                            <button onClick={() => openEditTask(task)} className="text-blue-600 font-medium hover:underline">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button onClick={() => deleteTask(task.id)} className="text-red-600 font-medium hover:underline">Ø­Ø°Ù</button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ - Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */}
        {showTaskForm && (
          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-4xl shadow-2xl my-8">
              <h2 className="text-2xl md:text-3xl font-bold mb-8">{currentTask ? "ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆØ¸ÛŒÙÙ‡" : "ÙˆØ¸ÛŒÙÙ‡ Ø¬Ø¯ÛŒØ¯"}</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block font-semibold mb-2">Ø¹Ù†ÙˆØ§Ù† <span className="text-red-500">*</span></label>
                  <input type="text" value={taskForm.title} onChange={e => setTaskForm({...taskForm, title: e.target.value})}
                         className="w-full border rounded-xl px-4 py-3 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500" required />
                </div>
                <div>
                  <label className="block font-semibold mb-2">Ø§Ù†Ø¬Ø§Ù…â€ŒØ¯Ù‡Ù†Ø¯Ù‡ <span className="text-red-500">*</span></label>
                  <select value={taskForm.assignee} onChange={e => setTaskForm({...taskForm, assignee: e.target.value})}
                          className="w-full border rounded-xl px-4 py-3 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500">
                    {users.map(u => (
                      <option key={u.id} value={u.id}>{u.name || u.email} ({u.id})</option>
                    ))}
                  </select>
                </div>
                <div className="md:col-span-2">
                  <label className="block font-semibold mb-2">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                  <textarea value={taskForm.description} onChange={e => setTaskForm({...taskForm, description: e.target.value})}
                            className="w-full border rounded-xl px-4 py-3 dark:bg-gray-700" rows="3"></textarea>
                </div>
                <JalaliDateInput
                  label="ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹"
                  value={taskForm.start_date}
                  onChange={(val) => setTaskForm(prev => ({...prev, start_date: val || ""}))}
                  name="start_date"
                />
                <JalaliDateInput
                  label="ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†"
                  value={taskForm.end_date}
                  onChange={(val) => setTaskForm(prev => ({...prev, end_date: val || ""}))}
                  name="end_date"
                />
                <div>
                  <label className="block font-semibold mb-2">Ø§ÙˆÙ„ÙˆÛŒØª</label>
                  <select value={taskForm.priority} onChange={e => setTaskForm({...taskForm, priority: e.target.value})}
                          className="w-full border rounded-xl px-4 py-3 dark:bg-gray-700">
                    <option value="low">Ú©Ù…</option>
                    <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                    <option value="high">Ø²ÛŒØ§Ø¯</option>
                  </select>
                </div>
                <div>
                  <label className="block font-semibold mb-2">ÙˆØ¶Ø¹ÛŒØª</label>
                  <select value={taskForm.status} onChange={e => setTaskForm({...taskForm, status: e.target.value})}
                          className="w-full border rounded-xl px-4 py-3 dark:bg-gray-700">
                    <option value="todo">Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡</option>
                    <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                    <option value="done">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
                    <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                  </select>
                </div>
                <div className="md:col-span-2">
                  <label className="block font-semibold mb-2">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                  <select value={taskForm.category} onChange={e => setTaskForm({...taskForm, category: e.target.value})}
                          className="w-full border rounded-xl px-4 py-3 dark:bg-gray-700">
                    <option value="">Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡</option>
                    {categories.map(cat => (
                      <option key={cat.id} value={cat.id}>{cat.name}</option>
                    ))}
                  </select>
                </div>
              </div>
              <div className="flex justify-end gap-4 mt-8">
                <button onClick={() => setShowTaskForm(false)} className="px-6 py-3 border rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700">Ù„ØºÙˆ</button>
                <button onClick={saveTask} className="bg-blue-600 text-white px-10 py-3 rounded-xl hover:bg-blue-700 shadow-lg">Ø°Ø®ÛŒØ±Ù‡</button>
              </div>
            </div>
          </div>
        )}

        {showCatForm && (
          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl my-8">
              <h2 className="text-2xl md:text-3xl font-bold mb-8">{currentCat ? "ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÙ‡" : "Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯"}</h2>
              <div className="space-y-8">
                <div>
                  <label className="block font-semibold mb-2">Ù†Ø§Ù… Ø¯Ø³ØªÙ‡ <span className="text-red-500">*</span></label>
                  <input type="text" value={catForm.name} onChange={e => setCatForm({...catForm, name: e.target.value})}
                         className="w-full border rounded-xl px-4 py-3 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500" required />
                </div>
                <div>
                  <label className="block font-semibold mb-2">Ø±Ù†Ú¯</label>
                  <input type="color" value={catForm.color} onChange={e => setCatForm({...catForm, color: e.target.value})}
                         className="w-full h-16 rounded-xl cursor-pointer" />
                </div>
              </div>
              <div className="flex justify-end gap-4 mt-8">
                <button onClick={() => setShowCatForm(false)} className="px-6 py-3 border rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700">Ù„ØºÙˆ</button>
                <button onClick={saveCategory} className="bg-blue-600 text-white px-10 py-3 rounded-xl hover:bg-blue-700 shadow-lg">Ø°Ø®ÛŒØ±Ù‡</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
{% endverbatim %}
</body>
</html>